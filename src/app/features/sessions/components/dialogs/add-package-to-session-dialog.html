<form [formGroup]="form" class="dialog-form">
    <!-- Package Selection -->
    <div class="form-field">
        <label for="package">
            Package <span class="required">*</span>
        </label>
        <p-select
            inputId="package"
            formControlName="package_id"
            [options]="packageOptions()"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar package"
            [filter]="true"
            filterBy="label"
            appendTo="body"
            [showClear]="true"
            [loading]="loading()"
            styleClass="w-full"
        />
        @if (form.get('package_id')?.invalid && form.get('package_id')?.touched) {
        <small class="error-message">El package es requerido</small>
        }
    </div>

    <!-- Package Details -->
    @if (selectedPackage()) {
    <div class="package-details">
        <div class="detail-row">
            <span class="detail-label">Precio del Package:</span>
            <span class="price-value">Q {{ formatCurrency(parseFloat(selectedPackage()!.base_price)) }}</span>
        </div>

        @if (selectedPackage()!.description) {
        <div class="description-section">
            <span class="detail-label">Descripción:</span>
            <p class="description-text">{{ selectedPackage()!.description }}</p>
        </div>
        }
    </div>

    <!-- Package Items Preview -->
    <div class="items-preview">
        <h4 class="items-preview-title">Items incluidos en el package:</h4>

        <div class="warning-message">
            <i class="pi pi-info-circle"></i>
            <span class="warning-text">Los items del package serán agregados individualmente a la sesión</span>
        </div>

        @if (loadingPackageDetails()) {
        <div class="items-table-wrapper">
            <div style="text-align: center; padding: 2rem;">
                <i class="pi pi-spinner pi-spin" style="font-size: 2rem;"></i>
                <p>Cargando items del package...</p>
            </div>
        </div>
        } @else if (packageItems().length > 0) {
        <div class="items-table-wrapper">
            <table class="items-table">
                <thead>
                    <tr>
                        <th class="text-left">Código</th>
                        <th class="text-left">Item</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-right">Precio Unit.</th>
                        <th class="text-right">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @for (item of packageItems(); track item.item_id) {
                    <tr>
                        <td class="text-left">{{ item.item_code }}</td>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-right">Q {{ formatCurrency(parseFloat(item.item_unit_price)) }}</td>
                        <td class="text-right">Q {{ formatCurrency(parseFloat(item.item_unit_price) * item.quantity) }}</td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        } @else {
        <div class="items-table-wrapper">
            <table class="items-table">
                <thead>
                    <tr>
                        <th class="text-left">Item</th>
                        <th class="text-center">Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="placeholder-row">
                        <td colspan="2">
                            <i class="pi pi-info-circle"></i>
                            Los items se mostrarán al seleccionar un package
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        }
    </div>
    }

    <!-- Actions -->
    <div class="dialog-actions">
        <p-button
            label="Cancelar"
            severity="secondary"
            [text]="true"
            (onClick)="cancel()"
            [disabled]="submitting()"
        />
        <p-button
            label="Agregar Package"
            icon="pi pi-box"
            (onClick)="onSubmit()"
            [disabled]="form.invalid || submitting()"
            [loading]="submitting()"
        />
    </div>
</form>
