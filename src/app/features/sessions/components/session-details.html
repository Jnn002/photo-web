<div class="session-details-container">
    @if (loading()) {
    <div class="loading-container">
        <p-progressBar mode="indeterminate" [style]="{ height: '6px' }" />
        <p class="text-600 mt-3">Cargando sesión...</p>
    </div>
    } @else if (session(); as sessionData) {
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="title-section">
                <h1>Sesión #{{ sessionData.id }}</h1>
                <p class="subtitle">
                    {{ currentClient()?.full_name || 'Cargando cliente...' }} -
                    {{ formatDate(sessionData.session_date) }}
                </p>
            </div>
        </div>
        <div class="header-actions">
            <p-button
                label="Editar"
                icon="pi pi-pencil"
                [outlined]="true"
                (onClick)="editSession()"
                [disabled]="!canEditSession()"
            />
            <p-button
                label="Cambiar Estado"
                icon="pi pi-sync"
                severity="info"
                (onClick)="openChangeStatusDialog()"
                [disabled]="!canChangeStatus()"
            />
            <p-button
                label="Volver"
                icon="pi pi-arrow-left"
                severity="secondary"
                [text]="true"
                (onClick)="router.navigate(['/sessions'])"
            />
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Left Column (Main Info) -->
        <div class="main-column">
            <!-- Información General -->
            <p-card>
                <ng-template pTemplate="header">
                    <div class="card-header">
                        <h2>Información General</h2>
                        <p-tag
                            [value]="getStatusBadge(sessionData.status).label"
                            [severity]="getStatusBadge(sessionData.status).severity"
                        />
                    </div>
                </ng-template>
                <ng-template pTemplate="content">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Estado</label>
                            <p-tag
                                [value]="getStatusBadge(sessionData.status).label"
                                [severity]="getStatusBadge(sessionData.status).severity"
                            />
                        </div>
                        <div class="info-item">
                            <label>Tipo</label>
                            <div class="info-value">{{ getSessionTypeLabel(sessionData.session_type) }}</div>
                        </div>
                        <div class="info-item">
                            <label>Fecha</label>
                            <div class="info-value">
                                <i class="pi pi-calendar"></i>
                                {{ formatDate(sessionData.session_date) }}
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Hora</label>
                            <div class="info-value">
                                <i class="pi pi-clock"></i>
                                {{ sessionData.session_time || 'No especificada' }}
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Duración</label>
                            <div class="info-value">{{ sessionData.estimated_duration_hours || '-' }} horas</div>
                        </div>
                        <div class="info-item">
                            <label>Ubicación</label>
                            <div class="info-value">
                                <i class="pi pi-map-marker"></i>
                                {{ sessionData.location || '-' }}
                            </div>
                        </div>
                    </div>
                </ng-template>
            </p-card>

            <!-- Cliente -->
            <p-card>
                <ng-template pTemplate="header">
                    <div class="card-header">
                        <h2>Cliente</h2>
                    </div>
                </ng-template>
                <ng-template pTemplate="content">
                    @if (currentClient(); as client) {
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Nombre</label>
                            <div class="info-value">{{ client.full_name }}</div>
                        </div>
                        <div class="info-item">
                            <label>Email</label>
                            <div class="info-value">
                                <i class="pi pi-envelope"></i>
                                <a [href]="'mailto:' + client.email">{{ client.email }}</a>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Teléfono</label>
                            <div class="info-value">
                                <i class="pi pi-phone"></i>
                                {{ client.primary_phone || '-' }}
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Tipo</label>
                            <div class="info-value">{{ client.client_type }}</div>
                        </div>
                    </div>
                    } @else {
                    <div class="text-center text-600">
                        <p-progressSpinner styleClass="w-3rem h-3rem" strokeWidth="4" />
                        <p>Cargando información del cliente...</p>
                    </div>
                    }
                </ng-template>
            </p-card>

            <!-- Requerimientos -->
            @if (sessionData.client_requirements || sessionData.internal_notes) {
            <p-card>
                <ng-template pTemplate="header">
                    <div class="card-header">
                        <h2>Requerimientos</h2>
                    </div>
                </ng-template>
                <ng-template pTemplate="content">
                    @if (sessionData.client_requirements) {
                    <div class="requirement-section">
                        <label>Requerimientos del Cliente</label>
                        <p class="requirement-text">{{ sessionData.client_requirements }}</p>
                    </div>
                    }
                    @if (sessionData.internal_notes) {
                    <div class="requirement-section">
                        <label>Notas Internas</label>
                        <p class="requirement-text internal">{{ sessionData.internal_notes }}</p>
                    </div>
                    }
                </ng-template>
            </p-card>
            }
        </div>

        <!-- Right Column (Financial Info) -->
        <div class="sidebar-column">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="card-header">
                        <h2>Información Financiera</h2>
                    </div>
                </ng-template>
                <ng-template pTemplate="content">
                    <div class="financial-summary">
                        <div class="financial-item total">
                            <label>Total</label>
                            <div class="amount">Q {{ formatCurrency(sessionData.total_amount) }}</div>
                        </div>
                        <div class="financial-item">
                            <label>Depósito</label>
                            <div class="amount-small">Q {{ formatCurrency(sessionData.deposit_amount) }}</div>
                        </div>
                        <div class="financial-item paid">
                            <label>Pagado</label>
                            <div class="amount-small">Q {{ formatCurrency(sessionData.paid_amount) }}</div>
                        </div>
                        <div class="financial-item balance">
                            <label>Balance</label>
                            <div class="amount-small">Q {{ formatCurrency(sessionData.balance_amount) }}</div>
                        </div>
                    </div>

                    <div class="payment-progress">
                        <label>Progreso de Pago</label>
                        <p-progressBar [value]="getPaymentProgress()" [showValue]="false" />
                        <small>{{ getPaymentProgress() }}% pagado</small>
                    </div>

                    <p-button
                        label="Registrar Pago"
                        icon="pi pi-dollar"
                        styleClass="w-full"
                        severity="success"
                        (onClick)="openRecordPaymentDialog()"
                    />

                    @if (payments().length > 0) {
                    <div class="payments-list">
                        <label>Historial de Pagos</label>
                        @for (payment of payments(); track payment.id) {
                        <div class="payment-item">
                            <div class="payment-info">
                                <span class="payment-type">{{ payment.payment_type }}</span>
                                <small>{{ formatDate(payment.payment_date) }}</small>
                            </div>
                            <span class="payment-amount">Q {{ formatCurrency(payment.amount) }}</span>
                        </div>
                        }
                    </div>
                    }
                </ng-template>
            </p-card>
        </div>
    </div>

    <!-- Items Contratados (Full Width) -->
    <p-card>
        <ng-template pTemplate="header">
            <div class="card-header">
                <h2>Items Contratados</h2>
                <div class="header-actions-inline">
                    <p-button
                        label="+ Item"
                        icon="pi pi-plus"
                        size="small"
                        [outlined]="true"
                        (onClick)="openAddItemDialog()"
                    />
                    <p-button
                        label="+ Package"
                        icon="pi pi-box"
                        size="small"
                        [outlined]="true"
                        (onClick)="openAddPackageDialog()"
                    />
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="content">
            @if (sessionDetails().length === 0) {
            <div class="empty-state">
                <i class="pi pi-inbox"></i>
                <p>No hay items contratados</p>
                <small>Agrega items o packages para comenzar</small>
            </div>
            } @else {
            <div class="items-table-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Item</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-right">Precio Unit.</th>
                            <th class="text-right">Subtotal</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (detail of sessionDetails(); track detail.id) {
                        <tr>
                            <td class="code-cell">{{ detail.item_code }}</td>
                            <td class="item-cell">
                                <div class="item-name">{{ detail.item_name }}</div>
                                @if (detail.item_description) {
                                <small class="item-description">{{ detail.item_description }}</small>
                                }
                            </td>
                            <td class="text-center">{{ detail.quantity }}</td>
                            <td class="text-right">Q {{ formatCurrency(detail.unit_price) }}</td>
                            <td class="text-right font-bold">Q {{ formatCurrency(detail.line_subtotal) }}</td>
                            <td class="text-center action-cell">
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    [text]="true"
                                    [rounded]="true"
                                    (onClick)="removeSessionDetail(detail.id)"
                                    pTooltip="Eliminar item"
                                    tooltipPosition="top"
                                />
                            </td>
                        </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right font-bold">Subtotal:</td>
                            <td class="text-right font-bold total-cell">
                                Q {{ formatCurrency(sessionData.total_amount) }}
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            }
        </ng-template>
    </p-card>

    <!-- Fotógrafos y Editor (2 Columns) -->
    <div class="team-grid">
        <!-- Fotógrafos -->
        <p-card>
            <ng-template pTemplate="header">
                <div class="card-header">
                    <h2>Fotógrafos Asignados</h2>
                </div>
            </ng-template>
            <ng-template pTemplate="content">
                @if (photographers().length === 0) {
                <div class="empty-state-small">
                    <i class="pi pi-users"></i>
                    <p>No hay fotógrafos asignados</p>
                </div>
                } @else {
                <div class="team-list">
                    @for (photographer of photographers(); track photographer.id) {
                    <div class="team-member">
                        <div class="member-info">
                            <span class="member-name">Fotógrafo #{{ photographer.photographer_id }}</span>
                            <small>{{ photographer.role || 'Sin rol especificado' }}</small>
                        </div>
                        @if (photographer.attended) {
                        <p-tag value="Asistió" severity="success" />
                        } @else {
                        <p-tag value="Asignado" severity="info" />
                        }
                    </div>
                    }
                </div>
                }
                <p-button
                    label="Asignar Fotógrafo"
                    icon="pi pi-user-plus"
                    styleClass="w-full mt-3"
                    [outlined]="true"
                    (onClick)="openAssignPhotographerDialog()"
                />
            </ng-template>
        </p-card>

        <!-- Editor -->
        <p-card>
            <ng-template pTemplate="header">
                <div class="card-header">
                    <h2>Editor Asignado</h2>
                </div>
            </ng-template>
            <ng-template pTemplate="content">
                @if (!sessionData.editing_assigned_to) {
                <div class="empty-state-small">
                    <i class="pi pi-user-edit"></i>
                    <p>No hay editor asignado</p>
                </div>
                } @else {
                <div class="team-list">
                    <div class="team-member">
                        <div class="member-info">
                            <span class="member-name">Editor #{{ sessionData.editing_assigned_to }}</span>
                            @if (sessionData.editing_started_at) {
                            <small>Inicio: {{ formatDateTime(sessionData.editing_started_at) }}</small>
                            }
                        </div>
                        @if (sessionData.editing_completed_at) {
                        <p-tag value="Completado" severity="success" />
                        } @else {
                        <p-tag value="En Progreso" severity="warn" />
                        }
                    </div>
                </div>
                }
                <p-button
                    label="Asignar Editor"
                    icon="pi pi-user-plus"
                    styleClass="w-full mt-3"
                    [outlined]="true"
                    (onClick)="openAssignEditorDialog()"
                    [disabled]="!!sessionData.editing_assigned_to"
                />
            </ng-template>
        </p-card>
    </div>

    <!-- Timeline de Estado -->
    <p-card>
        <ng-template pTemplate="header">
            <div class="card-header">
                <h2>Timeline de Estado</h2>
            </div>
        </ng-template>
        <ng-template pTemplate="content">
            @if (statusHistory().length === 0) {
            <div class="empty-state">
                <i class="pi pi-history"></i>
                <p>No hay historial de cambios</p>
            </div>
            } @else {
            <p-timeline [value]="statusHistory()" align="left">
                <ng-template pTemplate="marker" let-history>
                    <span
                        class="timeline-marker"
                        [style.background-color]="getStatusColor(history.to_status)"
                    >
                        <i class="pi pi-circle-fill"></i>
                    </span>
                </ng-template>
                <ng-template pTemplate="content" let-history>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="status-label">{{ history.to_status }}</span>
                            @if (history.from_status) {
                            <span class="status-transition">desde {{ history.from_status }}</span>
                            }
                        </div>
                        <small class="timeline-date">{{ formatDateTime(history.changed_at) }}</small>
                        @if (history.reason) {
                        <p class="timeline-reason">{{ history.reason }}</p>
                        }
                        @if (history.notes) {
                        <p class="timeline-notes">{{ history.notes }}</p>
                        }
                    </div>
                </ng-template>
            </p-timeline>
            }
        </ng-template>
    </p-card>
    }
</div>
